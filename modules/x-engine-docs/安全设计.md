

# 微应用

## 微应用(离线)

微应用包安全为了防止包被他人篡改. 即便有中间人攻击的情况下.

x-engine-app.json

``` json
{
  "appid":"",
  "pub_key":"",
  "digest_method":"md5" // default, 放微应用里还是 x-engine-app.json 里?
}
```



```
digest: 根据安全级别定义,默认 md5 算法
```



``` mermaid
sequenceDiagram
	  autonumber
	  participant a as App
	  participant u as 微应用.zip 开发者  
    participant s as 微应用服务 
    participant r as 资源服务
    participant b as 业务服务...
   	s-->>s: 生成 App 公私钥, p0, p1
   	s-->>b: 回调,绑定业务
   	a-->>a: embed App 公钥 p0
   	u->>s: 上传微应用 m1.zip包
   	s->>s: 用 p1 对微应用.zip digest(m1.zip) 值签名 
	  s->>r: 提交到资源服务器
	  s-->>b: 回调,绑定业务
	  a->>b: 请求微应用 m1
	  a->>a: 用 p0 验证 digest(m1) 是否合法
    

```

## 微应用(在线)

http://{host}:{port}/{path}/index.html

http://{host}:{port}/{path}/microapp.json 如果存在, 

http://{host}:{port}/{path}/index.html?microappid=xxx.xxx.xx&version=1

``` js
if(microappid && version)
{
   let microapp.json = request http://{host}:{port}/{path}/microapp.json
   if exist(microapp.json && validate(microapp.json)){
     let sitemap       = read microapp.json[sitemap];
     let files         = read sitempa.files;
     let files_content = read files;
      if microapp.json[signature]==md5(concat files_content){
        md5 check passed 
        bind appid.version to security config
      }else{
        md5 check failed x
      }

   }  
}else{
    pure h5 link
}
```







# 模块

## 数据封装

所有模块接口按如下格式返回

``` json
{
	code:"",
	data:..,
	message:""
}
```



code: 0   //代表数据正常

code: 403 //无权限

## 权限

每个微应用 zip 包里包含 microapp.json

```
{
	"id":"com.zkty.microapp.xxx",
	"version":2,
	//sitemap,用来做校验用.
	"sitemap":{
	
	},
	"permission":{
		"secrect":["{key}"],
		"module":{
			"{modulename}":{
				"scope":"all"
			},
		},
		"network":{
			"browser":{
				"enable":true
			},
			"native":{
				"enable":true
				]
			}
		}
	}
}
```



### 用户数据权限

> 要与 localstorage 模块的 public 域区分开. public 是由微应用认定数据一定可共享的. 没有权限限制. 

由模块 secrect 负责, secrect 内部数据 key:value 对由原生决定.

``` mermaid
sequenceDiagram
	  autonumber
    participant a as App
    participant m as microApp
    a-->>a: set secrect["username"]="xxxx"
    m-->>a: call secrect.get("{key}")
    a-->>a: check {key} of permission from microapp.json
    alt: 有权限
    a-->>m: 返回 secrect.get("{key}")
    else: 无权限
    a-->>m: 返回无权限
		end

```

### 接口权限
``` js

    //PHASE when microapp loaed
    securities[microappId,version] = model of microapp.json 
    ...

    //PHASE when microappId call module.method
    //called from webview
    microappid,version = $method(microapp)
    if !securities.check(microappId,version,module.method){
      ACCESS DENIED
    }
    ...
    // in module 
    // normal module logic
```


### 微应用网络权限

网络分为浏览器自带网络, 与转发网络.

``` mermaid
sequenceDiagram
	  autonumber
    participant m as Microapp
    participant w as WebView
    participant e as EngineContext
    participant s as Server
    m->>w: send request
    w->>w: check if enable
    alt enabled
    w->>s: delegate request
    else disabled
    w->>e: delegate request call    	
    end

```

### 路由权限 ?



