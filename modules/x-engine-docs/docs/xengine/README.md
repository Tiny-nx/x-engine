# xengine

## web 容器选型

android 各平台 web 引擎差异太大, android 将统一基于 X5 web 引擎.

iOS 端将统一使用 WkWebview

## h5 与 native 交互

js <-> native ,可同步, 可异步. 

数据仅为简单数据的传递. 会有一定性能损失.

## webview 高速渲染

webview 高速渲染保证了平滑的页面切换, 达到与原生基本一样的体验. 

可根据不同性能的机型, 使用单缓冲，双缓冲, 三缓冲, 以及 池化 webview .

都支持无限制下一页. 通过 web 模块暴露的方法切换缓冲模型。

|                | 离线渲染 | 原生动画 | 性能           | 无限时，内存使用 | 历史页面状态保持                       | 无缝后退 | 无缝前进 |
| -------------- | -------- | -------- | -------------- | ---------------- | -------------------------------------- | -------- | -------- |
| 单缓冲         | 否       | 不支持   | 非常高         | 一个 webview     | 有一通过浏览器特性保持中间状态，       | 支持     | 支持     |
| 双缓冲（弃用） | 是       | 支持     | 很高           | 2                | 能通过 url 复现界面,仅中间状态无法保持 | 支持     | 不支持   |
| 三缓冲（弃）   | 是       | 支持     | 高             | 3                | 能通过 url 复现界面,仅中间状态无法保持 | 支持     | 支持     |
| 无限渲染池     | 是       | 支持     | 随页面层级而定 | n                | 支持                                   | 支持     | 支持     |

单缓冲：

只使用一个 webview，  如果需要返回时还保持状态， 则对前端开发有一定的限制，在使用任何 js 框架时，必须得能保持住 state， 如 vue 里的 keep-alive，可

双缓冲渲染:

![2 buffer](assets/96d545a3-f590-4702-af05-81333fb828f2.gif )

三缓冲渲染: 

与双缓冲的区别在于, forward buffer 永远是空, 这样不会出现闪历史界面的问题.

![3webview-version 3](assets/045e984e-7bab-4181-95d2-b031f8b7ce56.gif)

池化 webview 渲染池 （默认）:

通用模拟线程池, 预加载 n 个, 根据需求自动收缩增长. 实现最简单, 效果最好, 缺点是, 吃内存，且 webview 只能在主线程创建.

xengine 对池化的数据结构做了优化处理。 

池为一个可伸缩的链表。 

一般情况下是感受不到伸缩的 UI 性能损耗。 

只有极少数情况，伸缩还未做完， 此时发生了 UI 的 push 或 pop ， 则会等待伸缩完成再处理。

详见 WebViewPool 类。

